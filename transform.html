<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link type="text/css" href="resources/css/ui-lightness/jquery-ui-1.8.16.custom.css" rel="stylesheet" />
    <link type="text/css" href="resources/webgl-tutorials.css" rel="stylesheet" />
    <style>
        #canvas {
            width: 600px;
            height: 600px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="uiContainer">
        <div id="ui">
            <div id="x"></div>
            <div id="y"></div>
            <div id="rotation"></div>
            <div id="scaleX"></div>
            <div id="scaleY"></div>
        </div>
    </div>
</body>

<script id="2d-vertex-shader" type="notjs">
    // 一个属性变量，将会从缓冲中获取数据
    attribute vec2 a_position;

    uniform vec2 u_resolution;
    uniform vec2 u_translation;
    uniform vec2 u_rotation;
    uniform vec2 u_scale;
    
    // 所有着色器都有一个main方法
    void main() {
        // 缩放
        vec2 scaledPosition = a_position * u_scale;

        // 旋转
        vec2 rotatedPosition = vec2(
            scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,
            scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x);

        // 平移
        vec2 position = rotatedPosition + u_translation;
    
        // 从像素坐标转换到 0.0 到 1.0
        vec2 zeroToOne = position / u_resolution;
        
        // 再把 0->1 转换 0->2
        vec2 zeroToTwo = zeroToOne * 2.0;
        
        // 把 0->2 转换到 -1->+1 (裁剪空间)
        vec2 clipSpace = zeroToTwo - 1.0;
        
        gl_Position = vec4(clipSpace * vec2(1, 1), 0, 1);
    }
</script>
<script id="2d-fragment-shader" type="notjs">
    precision mediump float;

    uniform vec4 u_color;
    
    void main() {
        gl_FragColor = u_color;
    }
</script>
<script src="resources/jquery-1.7.1.min.js"></script>
<script src="resources/jquery-ui-1.8.16.custom.min.js"></script>
<script src="resources/jquery.mousecapture.js"></script>
<script src="resources/jquery.gman.ui.js"></script>
<script src="resources/jquery-gman-circle.js"></script>
<script src="resources/webgl-utils.js"></script>
<script src="resources/webgl-lessons-ui.js"></script>
<script>
    function main() {
        var canvas = document.getElementById("canvas");
        var gl = canvas.getContext("webgl");

        var program = webglUtils.createProgramFromScripts(gl, ["2d-vertex-shader", "2d-fragment-shader"]);
        gl.useProgram(program);

        var positionLocation = gl.getAttribLocation(program, "a_position");
        var resolutionLocation = gl.getUniformLocation(program, "u_resolution");
        var colorLocation = gl.getUniformLocation(program, "u_color");
        var translationLocation = gl.getUniformLocation(program, "u_translation");
        var rotationLocation = gl.getUniformLocation(program, "u_rotation");
        var scaleLocation = gl.getUniformLocation(program, "u_scale");

        var positionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
        setGeometry(gl);

        var translation = [200, 200];
        var rotation = [0, 1];
        var scale = [1, 1];
        var color = [Math.random(), Math.random(), Math.random(), 1];

        drawScene();

        webglLessonsUI.setupSlider("#x", {value: translation[0], slide: updatePosition(0), max: gl.canvas.width });
        webglLessonsUI.setupSlider("#y", {value: translation[1], slide: updatePosition(1), max: gl.canvas.height});
        webglLessonsUI.setupSlider("#scaleX", {value: scale[0], slide: updateScale(0), min: -5, max: 5, step: 0.01, precision: 2});
        webglLessonsUI.setupSlider("#scaleY", {value: scale[1], slide: updateScale(1), min: -5, max: 5, step: 0.01, precision: 2});
        $("#rotation").gmanUnitCircle({
            width: 200,
            height: 200,
            value: 0,
            slide: function(e,u) {
            rotation[0] = u.x;
            rotation[1] = u.y;
            drawScene();
            }
        });

        function updatePosition(index) {
            return function(event, ui) {
                translation[index] = ui.value;
                drawScene();
            };
        }

        function updateScale(index) {
            return function(event, ui) {
            scale[index] = ui.value;
            drawScene();
            };
        }

        function drawScene() {
            webglUtils.resizeCanvasToDisplaySize(gl.canvas);
            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.useProgram(program);

            gl.enableVertexAttribArray(positionLocation);
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            var size = 2;          // 2 components per iteration
            var type = gl.FLOAT;   // the data is 32bit floats
            var normalize = false; // don't normalize the data
            var stride = 0;        // 0 = move forward size * sizeof(type) each iteration to get the next position
            var offset = 0;        // start at the beginning of the buffer
            gl.vertexAttribPointer(
                positionLocation, size, type, normalize, stride, offset);

            gl.uniform2f(resolutionLocation, gl.canvas.width, gl.canvas.height);
            gl.uniform4fv(colorLocation, color);
            gl.uniform2fv(translationLocation, translation);
            gl.uniform2fv(rotationLocation, rotation);
            gl.uniform2fv(scaleLocation, scale);

            var primitiveType = gl.TRIANGLES;
            var offset = 0;
            var count = 18;
            gl.drawArrays(primitiveType, offset, count);
        }
    }

    function setGeometry(gl) {
        gl.bufferData(
            gl.ARRAY_BUFFER,
            new Float32Array([
                // left column
                0, 0,
                30, 0,
                0, 150,
                0, 150,
                30, 0,
                30, 150,

                // top rung
                30, 0,
                100, 0,
                30, 30,
                30, 30,
                100, 0,
                100, 30,

                // middle rung
                30, 60,
                67, 60,
                30, 90,
                30, 90,
                67, 60,
                67, 90,
            ]),
            gl.STATIC_DRAW);
    }

    $(function(){
        main();
    });
</script>
</html>